<link rel="import" href="../polymer/polymer.html">

<script src="../underscore/underscore.js"></script>

<polymer-element name="rise-playlist">
  <template>
    <content id="items" select="rise-playlist-item"></content>
  </template>

  <script>
    /* global Polymer, _ */
    /*jshint newcap: false */
    Polymer("rise-playlist", {
      /**
       * The playlist items that have reported as being ready.
       *
       * @property items
       * @type object
       * @default []
       */
      items: [],

      /**
       * The total number of playlist items.
       *
       * @property totalItems
       * @type number
       * @default 0
       */
      totalItems: 0,

      /**
       * The number of playlist items that have reported as being ready.
       *
       * @property numItems
       * @type number
       * @default 0-
       */
      numItems: 0,

      /**
       * The ID of the timeout that fires if not all playlist items have reported ready after
       * a specified delay.
       *
       * @property loadingTimeout
       * @type number
       * @default 0
       */
      loadingTimeout: 0,

      /**
       * The delay (in ms) for the timeout that fires if not all playlist items have reported ready.
       *
       * @property loadingDelay
       * @type number
       * @default 30000
       */
      loadingDelay: 30000,

      /************************************** INITIALIZATION **************************************/

      /**
       * An instance of the element was inserted into the DOM.
       */
      attached: function() {
        var self = this,
          nodes = this.$.items.getDistributedNodes();

        for (var i = 0; i < nodes.length; i++) {
          if (nodes[i].nodeType === 1) {
            this.totalItems++;
          }
        }

        this.addEventListener("rise-component-ready", this.handleReady, false);
        this.addEventListener("rise-component-done", this.handleDone, false);

        this.loadingTimeout = setTimeout(function() {
          self.start();
        }, this.loadingDelay);
      },

      /**
       * Remove the event listener so that it won't be triggered by late-loading playlist items.
       */
      start: function() {
        if (this.items.length > 0) {
          this.sortItems();
          this.play(0);
          this.removeEventListener("rise-component-ready", this.handleReady, false);
        }
      },

      /***************************************** PLAYBACK *****************************************/

      /**
       * Add the playlist item to the items map if it does not already exist.
       */
      handleReady: function(e) {
        var item = {};

        // Playlist item has already been added.
        if (_.findWhere(this.items, { id: e.target.id }) !== undefined) {
          return;
        }

        item.id = e.target.id;
        item.element = e.target;

        if (e.detail) {
          if (e.detail.play) {
            item.play = e.detail.play;
          }

          if (e.detail.pause) {
            item.pause = e.detail.pause;
          }

          if (e.detail.stop) {
            item.stop = e.detail.stop;
          }

          if (e.detail.done) {
            item.done = e.detail.done;
          }
        }

        this.items.push(item);
        this.numItems++;

        if (this.numItems === this.totalItems) {
          this.start();
          clearTimeout(this.loadingTimeout);
        }

        e.stopPropagation();
      },

      /**
       * Play the next item in the playlist.
       */
      handleDone: function(e) {
        var nextIndex,
          itemsLength = this.items.length;

        this.hide();

        // Find current playlist item.
        for (var i = 0; i < itemsLength; i++) {
          if (this.items[i].id === e.target.id) {
            // Get next playlist item.
            nextIndex = (i + 1 < itemsLength) ? (i + 1): 0;

            this.play(nextIndex);
            break;
          }
        }

        e.stopPropagation();
      },

      /**
       * Play a playlist item.
       */
      play: function(index) {
        var self = this,
          item = null,
          duration = null;

        if ((index >= 0) && (index < this.items.length)) {
          item = this.items[index];
          duration = this.$.items.getDistributedNodes()[index].getAttribute("duration");

          this.hide();

          // Show the current playlist item.
          item.element.style.visibility = "visible";

          // Play the next item after the current one has completed.
          if (duration !== null) {
            duration = parseInt(duration, 10);

            if (!isNaN(duration)) {
              setTimeout(function() {
                self.playNext(index, "pause");
              }, duration * 1000);
            }
          }

          this.sendCommand(item, "play");
        }
      },

      /**
       * Play the next item in a playlist.
       */
      playNext: function(currentIndex, command) {
        var item, nextIndex,
          itemsLength = this.items.length;

        if ((currentIndex >= 0) && (currentIndex < itemsLength)) {
          item = this.items[currentIndex];

          this.sendCommand(item, command);

          // Play the next playlist item.
          nextIndex = (currentIndex + 1 < itemsLength) ? (currentIndex + 1): 0;
          this.play(nextIndex);
        }
      },

      /**
       * Pause a playlist item.
       */
      pause: function(index) {
        this.playNext(index, "pause");
      },

      /**
       * Stop a playlist item.
       */
      stop: function(index) {
        this.playNext(index, "stop");
      },

      /**
       * Sort playlist items.
       */
      sortItems: function() {
        var items = this.$.items.getDistributedNodes(),
          children = null;

        this.items = _.sortBy(this.items, function(item) {
          // Iterate over playlist items.
          for (var i = 0; i < items.length; i++) {
            if ((items[i].nodeType === 1) && items[i].hasChildNodes()) {
              children = items[i].childNodes;

              // Iterate over children of current playlist item.
              for (var j = 0; j < children.length; j++) {
                if (children[j].nodeType === 1) {
                  if (children[j].id === item.id) {
                    return item.id;
                  }
                }
              }
            }
          }
        });
      },

      /**
       * Hide all playlist items.
       */
      hide: function() {
        for (var i = 0; i < this.items.length; i++) {
          this.items[i].element.style.visibility = "hidden";
        }
      },

      /**
       * Send a command to a playlist item.
       */
      sendCommand: function(item, command) {
        if (item.hasOwnProperty(command)) {
          item[command].call(item.element);
        }
      }
    });
  </script>
</polymer-element>
