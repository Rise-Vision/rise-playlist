<link rel="import" href="../polymer/polymer.html">

<script src="../underscore/underscore.js"></script>

<dom-module id="rise-playlist">
  <template>
    <content id="items" select="rise-playlist-item"></content>
    <content id="distribution" select="rise-distribution"></content>
  </template>
</dom-module>

<script>
  /* global Polymer, _ */
  /*jshint newcap: false */
  Polymer({
    is: "rise-playlist",

    properties: {
      /**
       * The CSS class name for an intro transition.
       */
      intro: String,

      /**
       * The CSS class name for an outro transition.
       */
      outro: String
    },

    /**
     * The playlist items.
     */
    _items: [],

    /**
     * The total number of playlist items.
     */
    _totalItems: 0,

    /**
     * The number of playlist items that have reported as being ready.
     */
    _numItems: 0,

    /**
     * The delay (in ms) for the timeout that fires if not all playlist items have reported ready.
     */
    _loadingDelay: 5000,

    /**
     * The Display ID from the containing page element.
     */
     _displayId: "",

    /************************************** INITIALIZATION **************************************/

    /**
     * An instance of the element was inserted into the DOM.
     */
    attached: function() {
      var nodes = Polymer.dom(this.$.items).getDistributedNodes();

      this._items = [];
      this._displayId = this._getDisplayId();

      for (var i = 0; i < nodes.length; i++) {
        if (nodes[i].nodeType === 1) {
          this._addItem(nodes[i]);
          this._totalItems++;
        }
      }

      this._hideAll();
      this.addEventListener("rise-component-ready", this._handleReady, false);
      this.addEventListener("rise-component-done", this._handleDone, false);

      this.debounce("start", function() {
        this._start();
      }, this._loadingDelay);
    },

    /**
     * Dispatch rise-playlist-ready to indicate that the playlist has initialized.
     */
    _dispatchReady: function() {
      var readyEvent = new CustomEvent("rise-playlist-ready", {
        "detail": {
          "items": this._items
        },
        "bubbles": true
      });

      this.dispatchEvent(readyEvent);
    },

    /**
     * Add more details about a particular content element once it's ready.
     */
    _handleReady: function(e) {
      var item = _.findWhere(this._items, { id: e.target.id });

      // No content element with this id was found or it has already reported ready.
      if ((item === undefined) || item.isReady) {
        return;
      }

      // Check the distribution to see if the playlist item should play on this Display.
      if (this._canPlay(item)) {
        item.isReady = true;

        if (e.detail) {
          if (e.detail.play) {
            item.play = e.detail.play;
          }

          if (e.detail.pause) {
            item.pause = e.detail.pause;
          }

          if (e.detail.stop) {
            item.stop = e.detail.stop;
          }

          if (e.detail.done) {
            item.done = e.detail.done;
          }
        }
      }
      // Hide and remove the playlist item from the master array of items.
      else {
        item.element.style.display = "none";
        this._items = _.without(this._items, item);
      }

      this._numItems++;

      if (this._numItems === this._totalItems) {
        this._start();
        this.cancelDebouncer("start");
      }

      e.stopPropagation();
    },

    /**************************************** DISTRIBUTION ****************************************/

    /**
     * Determine whether or not to play a playlist item based on its distribution and the
     * Display ID of the page.
     */
    _canPlay: function(content) {
      var item = null,
        nodes = null,
        node = null,
        distribution = null,
        found = false;

      if (content.element) {
        item = content.element.parentNode;

        // Find the rise-distribution element.
        if (item && item.hasChildNodes()) {
          nodes = item.childNodes;

          for (var i = 0; i < nodes.length; i++) {
            node = nodes[i];

            if ((node.nodeType === 1) && (node.nodeName === "RISE-DISTRIBUTION")) {
              found = true;

              // Check if any of the distribution values match the Display ID.
              try {
                distribution = JSON.parse(node.getAttribute("distribution"));

                if (distribution !== null) {
                  for (var j = 0; j < distribution.length; j++) {
                    if (distribution[j].id === this._displayId) {
                      return true;
                    }
                  }
                }
              }
              catch (e) {
                console.log(e);
              }
            }
          }
        }
      }

      // Play the playlist item even if there is no rise-distribution element.
      if (!found) {
        return true;
      }
      else {
        return false;
      }
    },

    /**
     * Get the Display ID from the containing page element.
     */
    _getDisplayId: function() {
      if (this.parentNode && (this.parentNode.nodeName === "RISE-PAGE")) {
        return this.parentNode.getDisplayId();
      }

      return "";
    },

    /****************************************** PLAYBACK ******************************************/

    /**
     * Start playlist playback.
     */
    _start: function() {
      if (this._items.length > 0) {
        this._dispatchReady();
      }
    },

    /**
     * Play a playlist item.
     */
    play: function(index) {
      var item = this._getItem(index);

      // Only play and show the item if it's ready.
      if ((item !== null) && item.isReady) {
        this._show(index);
        this._sendCommand(item, "play");
      }
    },

    /**
     * Suspend playback of a playlist item.
     */
    _suspend: function(index, command) {
      var item = this._getItem(index);

      if (item !== null) {
        this._hide(index);
        this._sendCommand(item, command);
      }
    },

    /**
     * Play the next item in the playlist.
     */
    _playNext: function(index) {
      var duration,
        nextIndex = this._getNextIndex(index),
        nextItem = this._getItem(nextIndex);

      // Suspend current item.
      this._suspend(index, "pause");

      // Play next item.
      if ((nextItem !== null) && nextItem.isReady) {
        duration = nextItem.duration;

        // Ensure the item plays for its specified duration.
        if (duration !== 0) {
          this.debounce("play-next", function() {
            this._playNext(nextIndex);
          }, duration);
        }

        this.play(nextIndex);
      }
    },

    /**
     * Pause a playlist item.
     */
    pause: function(index) {
      this._suspend(index, "pause");
    },

    /**
     * Stop a playlist item.
     */
    stop: function(index) {
      this._suspend(index, "stop");
    },

    /**
     * Handle the rise-component-done event.
     */
    _handleDone: function(e) {
      // Find the playlist item that fired the event.
      for (var index = 0; index < this._items.length; index++) {
        if (this._items[index].id === e.target.id) {
          this._playNext(index);

          break;
        }
      }

      e.stopPropagation();
    },

    /************************************** HELPER FUNCTIONS **************************************/

    /**
     * Add the content element of a playlist item to _items.
     */
    _addItem: function(playlistItem) {
      var item = {},
        contentElement = null,
        duration = this._getDuration(playlistItem);

      contentElement = this._getContentElement(playlistItem);

      if (contentElement) {
        if (contentElement.id !== "") {
          item.isReady = false;
          item.duration = duration;
          item.id = contentElement.id;
          item.element = contentElement;

          this._items.push(item);
        }
      }
    },

    /**
     * Get the content element nested inside of the playlist item.
     */
    _getContentElement: function(playlistItem) {
      var children = null;

      if (playlistItem && playlistItem.hasChildNodes()) {
        children = playlistItem.childNodes;

        for (var i = 0; i < children.length; i++) {
          if (children[i].nodeType === 1) {
            return children[i];
          }
        }
      }

      return null;
    },

    /**
     * Get a playlist item by index.
     */
    _getItem: function(index) {
      var itemsLength = this._items.length;

      if ((index >= 0) && (index < itemsLength)) {
        return this._items[index];
      }

      return null;
    },

    /**
     * Get the duration of a playlist item.
     */
    _getDuration: function(playlistItem) {
      var duration = 0;

      if (playlistItem && playlistItem.hasAttribute("duration")) {
        duration = parseInt(playlistItem.getAttribute("duration"), 10);

        // Invalid duration
        if (isNaN(duration)) {
          duration = 0;
        }
      }
      else {
        duration = 0;
      }

      return duration * 1000;
    },

    /**
     * Get the index of the next playlist item.
     */
    _getNextIndex: function(index) {
      return (index + 1 < this._items.length) ? (index + 1): 0;
    },

    /**
     * Hide all playlist items.
     */
    _hideAll: function() {
      for (var i = 0; i < this._items.length; i++) {
        this._hide(i);
      }
    },

    /**
     * Hide playlist item.
     */
    _hide: function(index) {
      var item = this._getItem(index);

      if (item) {
        if (this.intro) {
          item.element.classList.remove(this.intro);
        }

        if (this.outro) {
          item.element.classList.add(this.outro);
        }
        else {
          item.element.style.display = "none";
        }
      }
    },

    /**
     * Show playlist item.
     */
    _show: function(index) {
      var item = this._getItem(index);

      if (item) {
        if (this.intro) {
          item.element.classList.add(this.intro);
        }
        else {
          item.element.style.display = "block";
        }

        if (this.outro) {
          item.element.classList.remove(this.outro);
        }
      }
    },

    /**
     * Send a command to a playlist item.
     */
    _sendCommand: function(item, command) {
      if (item.hasOwnProperty(command)) {
        item[command].call(item.element);
      }
    }
  });
</script>
