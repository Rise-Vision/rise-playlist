<link rel="import" href="../polymer/polymer.html">

<script src="../underscore/underscore.js"></script>

<polymer-element name="rise-playlist" attributes="intro outro">
  <template>
    <content id="items" select="rise-playlist-item"></content>
  </template>

  <script>
    /* global Polymer, _ */
    /*jshint newcap: false */
    Polymer("rise-playlist", {
      /**
       * The CSS class name for an intro transition.
       *
       * @attribute intro
       * @type string
       * @default ""
       */
      intro: "",

      /**
       * The CSS class name for an outro transition.
       *
       * @attribute outro
       * @type string
       * @default ""
       */
      outro: "",

      /**
       * The playlist items that have reported as being ready.
       *
       * @property items
       * @type object
       * @default []
       */
      items: [],

      /**
       * The total number of playlist items.
       *
       * @property totalItems
       * @type number
       * @default 0
       */
      totalItems: 0,

      /**
       * The number of playlist items that have reported as being ready.
       *
       * @property numItems
       * @type number
       * @default 0-
       */
      numItems: 0,

      /**
       * The ID of the timeout that fires if not all playlist items have reported ready after
       * a specified delay.
       *
       * @property loadingTimeout
       * @type number
       * @default 0
       */
      loadingTimeout: 0,

      /**
       * The delay (in ms) for the timeout that fires if not all playlist items have reported ready.
       *
       * @property loadingDelay
       * @type number
       * @default 30000
       */
      loadingDelay: 30000,

      /************************************** INITIALIZATION **************************************/

      /**
       * An instance of the element was inserted into the DOM.
       */
      attached: function() {
        var self = this,
          nodes = this.$.items.getDistributedNodes();

        for (var i = 0; i < nodes.length; i++) {
          if (nodes[i].nodeType === 1) {
            this.totalItems++;
          }
        }

        this.addEventListener("rise-component-ready", this.handleReady, false);
        this.addEventListener("rise-component-done", this.handleDone, false);

        this.loadingTimeout = setTimeout(function() {
          self.start();
        }, this.loadingDelay);
      },

      /**
       * Remove the event listener so that it won't be triggered by late-loading playlist items.
       */
      start: function() {
        if (this.items.length > 0) {
          this.sortItems();
          this.play(0);
          this.removeEventListener("rise-component-ready", this.handleReady, false);
        }
      },

      /***************************************** PLAYBACK *****************************************/

      /**
       * Add the playlist item to the items map if it does not already exist.
       */
      handleReady: function(e) {
        var item = {};

        // Playlist item has already been added.
        if (_.findWhere(this.items, { id: e.target.id }) !== undefined) {
          return;
        }

        item.id = e.target.id;
        item.element = e.target;

        if (e.detail) {
          if (e.detail.play) {
            item.play = e.detail.play;
          }

          if (e.detail.pause) {
            item.pause = e.detail.pause;
          }

          if (e.detail.stop) {
            item.stop = e.detail.stop;
          }

          if (e.detail.done) {
            item.done = e.detail.done;
          }
        }

        this.items.push(item);
        this.numItems++;

        if (this.numItems === this.totalItems) {
          this.start();
          clearTimeout(this.loadingTimeout);
        }

        e.stopPropagation();
      },

      /**
       * Play the next item in the playlist.
       */
      handleDone: function(e) {
        var nextIndex,
          item = null,
          itemsLength = this.items.length;

        // Find current playlist item.
        for (var index = 0; index < itemsLength; index++) {
          if (this.items[index].id === e.target.id) {
            item = this.items[index];
            nextIndex = (index + 1 < itemsLength) ? (index + 1): 0;

            // Current playlist item
            this.hide(index);
            this.sendCommand(item, "pause");

            // Next playlist item
            this.play(nextIndex);

            break;
          }
        }

        e.stopPropagation();
      },

      /**
       * Play a playlist item.
       */
      play: function(index) {
        var self = this,
          item = this.getItem(index),
          duration = null;

        if (item !== null) {
          duration = this.$.items.getDistributedNodes()[index].getAttribute("duration");

          // Play the next item after the current one has completed.
          if (duration !== null) {
            duration = parseInt(duration, 10);

            if (!isNaN(duration)) {
              setTimeout(function() {
                self.playNext(index, "pause");
              }, duration * 1000);
            }
          }

          this.show(index);
          this.sendCommand(item, "play");
        }
      },

      /**
       * Play the next item in a playlist.
       */
      playNext: function(index, command) {
        var item = this.getItem(index),
          nextIndex = (index + 1 < this.items.length) ? (index + 1) : 0;

        if (item !== null) {
          // Current playlist item
          this.hide(index);
          this.sendCommand(item, command);

          // Next playlist item
          this.play(nextIndex);
        }
      },

      /**
       * Pause a playlist item.
       */
      pause: function(index) {
        this.playNext(index, "pause");
      },

      /**
       * Stop a playlist item.
       */
      stop: function(index) {
        this.playNext(index, "stop");
      },

      /**
       * Get a playlist item by index.
       */
      getItem: function(index) {
        var itemsLength = this.items.length;

        if ((index >= 0) && (index < itemsLength)) {
          return this.items[index];
        }

        return null;
      },

      /**
       * Sort playlist items.
       */
      sortItems: function() {
        var items = this.$.items.getDistributedNodes(),
          children = null;

        this.items = _.sortBy(this.items, function(item) {
          // Iterate over playlist items.
          for (var i = 0; i < items.length; i++) {
            if ((items[i].nodeType === 1) && items[i].hasChildNodes()) {
              children = items[i].childNodes;

              // Iterate over children of current playlist item.
              for (var j = 0; j < children.length; j++) {
                if (children[j].nodeType === 1) {
                  if (children[j].id === item.id) {
                    return item.id;
                  }
                }
              }
            }
          }
        });
      },

      /**
       * Hide playlist item.
       */
      hide: function(index) {
        var item = this.getItem(index);

        if (item) {
          if (this.intro) {
            item.element.classList.remove(this.intro);
          }

          if (this.outro) {
            item.element.classList.add(this.outro);
          }
          else {
            item.element.style.display = "none";
          }
        }
      },

      /**
       * Show playlist item.
       */
      show: function(index) {
        var item = this.getItem(index);

        if (item) {
          if (this.intro) {
            item.element.classList.add(this.intro);
          }
          else {
            item.element.style.display = "block";
          }

          if (this.outro) {
            item.element.classList.remove(this.outro);
          }
        }
      },

      /**
       * Send a command to a playlist item.
       */
      sendCommand: function(item, command) {
        if (item.hasOwnProperty(command)) {
          item[command].call(item.element);
        }
      }
    });
  </script>
</polymer-element>
